#! /usr/bin/env python3
import os
#import re
import requests
import json
import zipfile
from collections import OrderedDict, Counter
from datetime import datetime, timedelta
import os
import time
import urllib.request
import pprint
pp = pprint.PrettyPrinter(indent=4)

class CveEntry():
    def __init__(self, cve_item):
        # copy all key-value pairs into new dict
        self.cve_dict = dict()
        for key, value in cve_item.items():
            self.cve_dict[key] = value
        
        self.cve_dict['ID']            = cve_item['cve']['CVE_data_meta']['ID']
        
        self.cve_dict['publishedDate'] = cve_item['publishedDate']
        datetime_object = datetime.strptime(self.cve_dict['publishedDate'], '%Y-%m-%dT%H:%MZ') # '2019-03-26T18:29Z'
        self.cve_dict['publishedDate'] = datetime_object
        #print(cve_dict['publishedDate'])
        
        self.cve_dict['lastModifiedDate'] = self.cve_dict['lastModifiedDate']
        datetime_object = datetime.strptime(self.cve_dict['lastModifiedDate'], '%Y-%m-%dT%H:%MZ') # '2019-04-03T17:22Z'
        self.cve_dict['lastModifiedDate'] = datetime_object
        #print(cve_dict['lastModifiedDate'])
        
        self.cve_dict['newestDate'] = min([self.cve_dict['publishedDate'], self.cve_dict['lastModifiedDate']])
        
        # vendors and products
        product_vendor_names = list()
        for vendor_data in cve_item['cve']['affects']['vendor']['vendor_data']:
            for product_data in vendor_data['product']['product_data']:
                product_vendor_names.append( (vendor_data['vendor_name'], product_data['product_name']) )
        self.cve_dict['product_vendor_names'] = product_vendor_names
        
        self.v_and_p = 'no_vendor_and_product_info'
        if len(product_vendor_names) > 0:
            self.v_and_p = '|'.join([x[0] + '_' + x[1] for x in product_vendor_names])
        
        # description
        descriptions = list()
        for description_data in cve_item['cve']['description']['description_data']:
            descriptions.append(description_data['value'])
        self.cve_dict['descriptions'] = descriptions
        
        self.description = 'no_description_info'
        if len(descriptions) > 0:
            self.description = '|'.join(descriptions)
        
        # scoring
        self.cvss2_score = 0
        self.cvss3_score = 0
        self.scoring = 'no_score_info'
        cvss_scores = list()
        for key in ['baseMetricV2', 'baseMetricV3']:
            if key in self.cve_dict['impact']:
                cvss_scores.append('{}:{}'.format( \
                    key[-2:], \
                    self.cve_dict['impact'][key]['impactScore']))
                    
                try:
                    if key == 'baseMetricV2':
                        self.cvss2_score = float(self.cve_dict['impact'][key]['impactScore'])
                    elif key == 'baseMetricV3':
                        self.cvss3_score = float(self.cve_dict['impact'][key]['impactScore'])
                except:
                    pass
        
        if len(cvss_scores) > 0:
            self.scoring = '|'.join(cvss_scores)
        
    def __str__(self):
        return '{}: {}, {}, {}, {}'.format( \
            self.cve_dict['ID'], \
            self.scoring, \
            self.cve_dict['newestDate'], \
            self.v_and_p, \
            self.description[:30])

def parse_NVD_CVE_files(path_to_json_file):
    if not os.path.isfile(path_to_json_file):
        print('File {} does not exist!'.format(path_to_json_file))
        return None
        
    with open(path_to_json_file) as json_file:
        print('Parsing file {}'.format(path_to_json_file))
        cve_data = json.load(json_file)
        #pp.pprint(cve_data)
        print('Number of CVE entries: {}'.format(len(cve_data['CVE_Items'])))
        print('-----')
        pp.pprint(cve_data['CVE_Items'][0].keys())
        print('-----')
        pp.pprint(cve_data['CVE_Items'][1].keys())
        
        # query certain values from the dictionary
        # cve_data['CVE_Items'][1].keys() =
        # dict_keys(['cve', 'configurations', 'impact', 'publishedDate', 'lastModifiedDate'])
        CveEntry_list = [CveEntry(cve_dict) for cve_dict in cve_data['CVE_Items']]
            
        print('Number of CVE entries in cve_dict_list: {}'.format(len(CveEntry_list)))
        # sort CVE entries by newest date
        CveEntry_list.sort(key=lambda x: x.cve_dict['newestDate'], reverse=True)
        for cve_entry in CveEntry_list[0:20]:
            print(cve_entry)
           
        print('\nSorted by CVSS 2 score:')
        # sort CVE entries by CVSS 2 score
        CveEntry_list.sort(key=lambda x: x.cvss2_score, reverse=True)
        for cve_entry in CveEntry_list[0:20]:
            print(cve_entry)
        
        print('\nSorted by CVSS 3 score:')
        # sort CVE entries by CVSS 3 score
        CveEntry_list.sort(key=lambda x: x.cvss3_score, reverse=True)
        for cve_entry in CveEntry_list[0:20]:
            print(cve_entry)
            
        # determine vendors and products
        vendors_and_products = list()
        cve_without_vendor_and_product = list()
        for cve_entry in CveEntry_list:
            if len(cve_entry.cve_dict['product_vendor_names']) < 1:
                cve_without_vendor_and_product.append(cve_entry)
            else:
                vendors_and_products.extend(cve_entry.cve_dict['product_vendor_names'])
        unique_vendors = set(vendors_and_products)
        pp.pprint(unique_vendors)

        # print "top" vendors for count of vulnerabilities
        print("\nTop 20 vendors by number of vulnerabilities:")
        vendor_list = [vendor_and_product[0] for vendor_and_product in vendors_and_products]
        ranking = 1
        for vendor, count in Counter(vendor_list).most_common(20):
            print('{}) {}: {}'.format(ranking, vendor, count))
            ranking += 1
        
        
def extract_ZIP_files(directory=os.getcwd()):
    if not os.path.isdir(directory):
        print('Directory {} does not exist!'.format(directory))
        return list()
    
    zip_file_count = 0
    zip_extracted = list()
    zip_failed = list()
    extracted_filenames = list()
    for my_file in os.listdir(directory):
        if my_file.lower().endswith('.zip'):
            path_to_zip_file = os.path.join(directory, my_file)
            zip_file_count += 1
            print('Extracting ZIP file {}: {}'.format(zip_file_count, path_to_zip_file))
            try:
                with zipfile.ZipFile(path_to_zip_file, 'r') as zip_ref:
                    zip_ref.extractall()
                    for member in zip_ref.infolist():
                        extracted_filenames.append(os.path.join(directory, member.filename))
                        print('Member filename: {}'.format(member.filename))
                zip_extracted.append(path_to_zip_file)
            except Exception as e:
                print('FAILED to extract ZIP file: {}'.format(path_to_zip_file))
                print(e)
                zip_failed.append(path_to_zip_file)
    
    # print statistics
    print('{} ZIP files processed in total:'.format(zip_file_count))
    for i, zip_file in enumerate(zip_extracted, 1):
        print('\t{}) {} SUCCESS'.format(i, zip_file))
    for i, zip_file in enumerate(zip_failed, 1):
        print('\t{}) {} FAILED'.format(i, zip_file))
    return extracted_filenames

def download_NVD_CVE_files(directory=os.getcwd()):
    zip_json_modified = 'nvdcve-1.0-modified.json.zip'
    zip_json_modified_url = 'https://nvd.nist.gov/feeds/json/cve/1.0/nvdcve-1.0-modified.json.zip'
    zip_json_recent = 'nvdcve-1.0-recent.json.zip'
    zip_json_recent_url = 'https://nvd.nist.gov/feeds/json/cve/1.0/nvdcve-1.0-recent.json.zip'
    
    downloaded_files = list()
    for url in [zip_json_modified_url, zip_json_recent_url]:
        local_filename = os.path.join(directory, url.split('/')[-1])
        
        if os.path.isfile(local_filename):
            # check age of file
            dt_now = datetime.now()
            dt_modified = datetime.fromtimestamp(os.path.getmtime(local_filename))
            print('Last modified: {}'.format(dt_modified))
            dt_created = datetime.fromtimestamp(os.path.getctime(local_filename))
            print('Created: {}'.format(dt_created))
            print('Age of file {}: {}'.format(local_filename, (dt_now - dt_created).total_seconds()))
            if ((dt_now - dt_created).total_seconds() > 60*60):
                print('Older than 1 hour! Downloading new file...')
                my_file = download_remote_file(url, local_filename)
                if my_file is not None:
                    downloaded_files.append(my_file)
        else:
            download_remote_file(url, local_filename)
            my_file = download_remote_file(url, local_filename)
            if my_file is not None:
                downloaded_files.append(my_file)
                
    return downloaded_files

def download_remote_file(url, local_filename):
    if not '/' in url:
        print('No URL provided!')
        return None
    
    # try to download the file
    try:
        urllib.request.urlretrieve(url, local_filename)
        return local_filename
    except Exception as e:
        print('FAILED to download URL: {}'.format(url))
        print(e)
    
    return None

def main():
    zip_files = download_NVD_CVE_files()
    print('{} files downloaded'.format(len(zip_files)))
    for i, zip_file in enumerate(zip_files, 1):
        print('\t{}) {}'.format(i, zip_file))
    json_files = extract_ZIP_files()
    print(', '.join(json_files))
    for json_file in json_files:
        parse_NVD_CVE_files(json_file)

if __name__ == '__main__':
    main()
